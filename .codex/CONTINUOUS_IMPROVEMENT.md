# Система Непрерывного Улучшения

## Обзор

Система автоматически:
- ✅ Запускает и поддерживает бота в рабочем состоянии
- ✅ Мониторит runtime ошибки в логах
- ✅ Автоматически запускает Codex при обнаружении ошибок
- ✅ Периодически улучшает код (каждый час)
- ✅ Перезапускает бота после улучшений

## Запуск

### В tmux сессии (рекомендуется)

```bash
cd /root/bot_hnushka
tmux attach -t hnushka
./.codex/continuous_improvement.sh
```

### Автозапуск при старте системы

Добавить в crontab:
```bash
@reboot cd /root/bot_hnushka && tmux new-session -d -s hnushka -c /root/bot_hnushka "./.codex/continuous_improvement.sh"
```

## Как это работает

### 1. Запуск бота
- Бот запускается автоматически при старте скрипта
- Проверяется что бот работает каждые 5 минут
- Автоматический перезапуск при падении

### 2. Мониторинг ошибок
- Каждые 5 минут проверяются логи бота (`bot.log`)
- Ищутся: `error`, `exception`, `traceback`, `failed`, `critical`, `fatal`
- При обнаружении ошибок → немедленный запуск Codex

### 3. Улучшение кода
- **При ошибках**: Codex запускается немедленно
- **По расписанию**: каждые 60 минут (настраивается)
- Codex анализирует код, исправляет проблемы, тестирует
- После улучшений бот перезапускается

### 4. Логирование
- `bot.log` - логи бота
- `.codex/errors.log` - история ошибок
- `.codex/improvement.log` - логи улучшений Codex

## Настройка

### Интервал улучшений

Измените в скрипте:
```bash
IMPROVEMENT_INTERVAL=3600  # секунды (3600 = 1 час)
```

### Интервал проверки

Измените в конце цикла:
```bash
sleep 300  # секунды (300 = 5 минут)
```

## Управление

### Просмотр статуса
```bash
tmux attach -t hnushka
# Посмотреть вывод скрипта
```

### Остановка
```bash
# В tmux: Ctrl+C
# Или из другого терминала:
tmux send-keys -t hnushka C-c
```

### Проверка логов
```bash
# Логи бота
tail -f bot.log

# Логи ошибок
tail -f .codex/errors.log

# Логи улучшений
tail -f .codex/improvement.log
```

### Проверка процессов
```bash
# Проверить что бот работает
ps aux | grep "python.*main.py"

# Проверить PID бота
cat .codex/bot.pid
```

## Структура работы

```
┌─────────────────────────────────┐
│  Continuous Improvement Loop    │
├─────────────────────────────────┤
│  1. Проверка бота (каждые 5 мин)│
│  2. Проверка ошибок в логах      │
│  3. Если ошибки → Codex          │
│  4. Если прошёл час → Codex      │
│  5. Перезапуск бота после Codex │
│  6. Пауза 5 минут                │
└─────────────────────────────────┘
```

## Приоритеты

1. **Runtime ошибки** - исправляются немедленно
2. **Периодическое улучшение** - каждые 60 минут
3. **Мониторинг бота** - постоянная проверка работы

## Безопасность

- Бот останавливается перед запуском Codex
- Бот перезапускается после улучшений
- Все изменения логируются
- Процессы отслеживаются по PID

## Troubleshooting

### Бот не запускается
```bash
# Проверить логи
tail -50 bot.log

# Проверить конфигурацию
source venv/bin/activate
python3 -c "from config import settings; print('OK')"
```

### Codex не запускается
```bash
# Проверить авторизацию
codex login status

# Проверить логи
tail -50 .codex/improvement.log
```

### Бот падает постоянно
```bash
# Проверить ошибки
tail -100 bot.log | grep -i error

# Запустить Codex вручную для исправления
./.codex/run_codex.sh
```

